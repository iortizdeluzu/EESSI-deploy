Bootstrap: docker
From: rockylinux:8

%post
    # Instalar dependencias
    dnf -y install epel-release curl
    # Actualizar e instalar CVMFS
    curl -o /etc/yum.repos.d/cernvm.repo https://cvmrepo.web.cern.ch/cvmrepo/yum/cernvm.repo
    dnf clean all
    dnf install -y cvmfs cvmfs-config-default

    # Crear directorios necesarios
    mkdir -p /etc/cvmfs/keys
    mkdir -p /cvmfs/example.domain.tld

    # Configuración básica de CVMFS
    echo "CVMFS_REPOSITORIES=example.domain.tld" > /etc/cvmfs/default.local
    echo "CVMFS_SERVER_URL=http://localhost/cvmfs/@fqrn@" >> /etc/cvmfs/default.local
    echo "CVMFS_KEYS_DIR=/etc/cvmfs/keys" >> /etc/cvmfs/default.local
    echo "CVMFS_PUBLIC_KEY=/etc/cvmfs/keys/example.domain.tld.pub" >> /etc/cvmfs/default.local

    # Inicializar CVMFS
    cvmfs_config setup

%files
example.domain.tld.pub /etc/cvmfs/keys/example.domain.tld.pub

%runscript
    echo "Contenedor CVMFS listo. Montando repositorio..."
    cvmfs2 -o config=/etc/cvmfs/default.local example.domain.tld /cvmfs/example.domain.tld
    exec bash
